
# Battus Museum Data 

#### CVAT Labeling and Data Setup
- Labels: tags, ruler, lepidopteran 
    ```json
    [
      { "name": "tags",         "id": 1, "color": "#00ff00", "type": "mask", "attributes": [] },
      { "name": "ruler",        "id": 2, "color": "#ffff00", "type": "mask", "attributes": [] },
      { "name": "lepidopteran", "id": 3, "color": "#ff0000", "type": "mask", "attributes": [] }
    ]
    ```
    - [Insert Screenshot]
- Use SAM for semi-automated mask labeling
    - [Insert Screenshot]
- Export the project as CamVid from Battus labeling project 
    - [Insert Screenshot]
    - Copy training and validation images to the battus100 folders
    - Run the [./prep_images.py](./prep_images.py) script to setup the grayscale and label images 


### FastAI Training Notebook
- UNET model for semantic segmentation [`train.ipynb`](./train.ipynb)
  - References:
    - FastAI - https://colab.research.google.com/github/visual-layer/vl-datasets/blob/main/notebooks/train-fastai.ipynb
    - FastAI - https://github.com/ashutoshraj/Dynamic-Unet/blob/master/caravan-work.ipynb
- Train the models on Battus100 dataset [`train.py`](./train.py)
  - Resnet34, Batch 4, Epoch 50 with image resolution as 1200x800 
  ```log
    /mothra/data$ python train.py
    Unique labels: {'background': 0, 'lepidopteran': 1, 'tags': 2, 'ruler': 3}
    2024-04-09 18:15:16.092956       Total Images: 80        Sample:  /home/rahul/workspace/vision/eeb/mothra/data/battus100/training_images/images/IMG_4810.JPG
    2024-04-09 18:15:21.760610       Creating Learner, loading the model
    2024-04-09 18:15:43.701323       Train model for epochs= 50
    epoch     train_loss  valid_loss  acc_camvid  time
    0         0.806768    0.459883    0.636961    02:33
    epoch     train_loss  valid_loss  acc_camvid  time
    0         0.149808    0.128320    0.808339    09:12
    1         0.115419    0.079170    0.896724    10:41
    2         0.095822    0.079611    0.954942    14:17
    3         0.084676    0.051534    0.953409    03:59
    4         0.072986    0.038313    0.943552    04:43
    5         0.062362    0.033027    0.948094    07:52
    6         0.057291    0.036135    0.953725    05:45
    7         0.052212    0.039786    0.919670    16:04
    8         0.046736    0.026606    0.967843    05:24
    9         0.043211    0.033908    0.986602    12:12
    10        0.040234    0.046850    0.973135    07:54
    11        0.039036    0.030431    0.944569    06:53
    12        0.037563    0.026196    0.958800    05:09
    13        0.035784    0.028760    0.974625    06:14
    14        0.033103    0.027583    0.980055    07:27
    15        0.032790    0.044074    0.959578    11:16
    16        0.032898    0.028118    0.976511    07:45
    17        0.032550    0.029431    0.950204    14:27
    18        0.036883    0.044919    0.911377    06:30
    19        0.037076    0.026376    0.971383    07:01
    20        0.033519    0.027041    0.972268    18:33
    21        0.031397    0.023548    0.968206    05:32
    22        0.029965    0.023719    0.970279    07:47
    23        0.028803    0.023212    0.966944    05:48
    24        0.027795    0.023248    0.977940    08:06
    25        0.026741    0.028469    0.944889    05:45
    26        0.025991    0.023879    0.960224    11:14
    27        0.024507    0.023116    0.964569    05:33
    28        0.024004    0.023602    0.966349    04:52
    29        0.023738    0.021643    0.962317    06:40
    30        0.023573    0.024443    0.965278    08:04
    31        0.023717    0.036110    0.953635    08:12
    32        0.023424    0.022199    0.974851    07:46
    33        0.023092    0.023003    0.968156    05:39
    34        0.023080    0.021869    0.967127    06:15
    35        0.021702    0.028368    0.957976    07:21
    36        0.020507    0.022182    0.968752    09:23
    37        0.019944    0.025000    0.963409    14:15
    38        0.019134    0.026316    0.962307    06:44
    39        0.018094    0.032151    0.964344    06:25
    40        0.017827    0.025473    0.964131    05:09
    41        0.017791    0.026449    0.967641    04:25
    42        0.017935    0.029951    0.964231    04:54
    43        0.017605    0.034360    0.963989    04:32
    44        0.017242    0.028126    0.965754    05:38
    45        0.017434    0.028271    0.964929    05:06
    46        0.017079    0.029187    0.965438    05:48
    47        0.017186    0.029525    0.965751    06:16
    48        0.017077    0.029003    0.966066    06:46
    49        0.016688    0.030077    0.965412    04:39
    2024-04-10 00:42:35.306840       Export Model to *.pkl
    2024-04-10 00:42:36.041505       Done
  ```
  - Resnet18, Batch 8, Epoch 50 with image resolution as 1200x800 
  ```log
  Wed Apr 10 11:28:40 2024
  +-----------------------------------------------------------------------------+
  | NVIDIA-SMI 515.65.01    Driver Version: 515.65.01    CUDA Version: 11.7     |
  |-------------------------------+----------------------+----------------------+
  | GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |
  | Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |
  |                               |                      |               MIG M. |
  |===============================+======================+======================|
  +-------------------------------+----------------------+----------------------+
  |   4  NVIDIA RTX A6000    On   | 00000000:81:00.0 Off |                  Off |
  | 30%   38C    P8    20W / 300W |  46976MiB / 49140MiB |      0%      Default |
  |                               |                      |                  N/A |
  +-------------------------------+----------------------+----------------------+

  +-----------------------------------------------------------------------------+
  | Processes:                                                                  |
  |  GPU   GI   CI        PID   Type   Process name                  GPU Memory |
  |        ID   ID                                                   Usage      |
  |=============================================================================|
  |    4   N/A  N/A   2229241      C   python                          46973MiB |
  +-----------------------------------------------------------------------------+
  ```
  ```log
  (mothra) /mothra/data$ time python train.py
  2024-04-10 11:20:08.600215       Unique labels: {'background': 0, 'lepidopteran': 1, 'tags': 2, 'ruler': 3}
  2024-04-10 11:20:08.600613       Loading segmentation masks data for images: 80          Sample:  /home/rahul/workspace/vision/eeb/mothra/data/battus100/training_images/images/IMG_4810.JPG
  2024-04-10 11:20:23.726984       Creating Learner, initialized the UNET segmentation model
  2024-04-10 11:22:24.357764       Train model for epochs= 50
  epoch     train_loss  valid_loss  acc_camvid  time
  0         1.441202    1.229148    0.787606    04:13
  epoch     train_loss  valid_loss  acc_camvid  time
  0         0.673551    0.307634    0.575747    18:31
  1         0.433551    0.500288    0.509545    25:04
  2         0.319499    0.109384    0.826424    30:27
  3         0.249172    0.086661    0.906845    22:23
  4         0.200040    0.076767    0.939930    46:33
  5         0.167633    0.056497    0.939350    42:06
  6         0.142033    0.045660    0.948159    28:27
  7         0.124056    0.042898    0.978093    20:45
  8         0.108796    0.048028    0.965724    21:55
  9         0.096609    0.029668    0.957614    19:27
  10        0.087679    0.035286    0.974350    19:58
  11        0.079247    0.030337    0.978533    20:28
  12        0.071945    0.028291    0.977861    19:05
  13        0.066621    0.057188    0.961796    22:05
  14        0.062677    0.033123    0.980066    19:17
  15        0.057759    0.027264    0.968835    18:30
  16        0.052858    0.030486    0.973210    21:10
  17        0.049290    0.032231    0.950006    16:50
  18        0.046210    0.030739    0.969893    19:21
  19        0.043711    0.028790    0.983825    16:33
  20        0.041335    0.025464    0.978610    20:07
  21        0.038585    0.028012    0.977014    17:04
  22        0.038194    0.032870    0.942774    16:19
  23        0.037524    0.030059    0.982937    19:28
  24        0.036380    0.026826    0.979021    19:28
  25        0.035418    0.024742    0.981831    17:26
  26        0.033927    0.025954    0.984215    17:36
  27        0.032495    0.023823    0.978638    16:32
  28        0.031544    0.027179    0.984380    20:05
  29        0.030671    0.021320    0.973813    17:42
  30        0.029892    0.021909    0.974061    19:16
  31        0.028770    0.022489    0.977125    15:20
  32        0.027447    0.023036    0.979408    16:58
  33        0.026704    0.023347    0.971066    17:11
  34        0.025838    0.022143    0.977087    14:43
  35        0.025290    0.022623    0.973732    12:57
  36        0.024848    0.022311    0.976318    16:46
  37        0.024174    0.024361    0.978484    17:24
  38        0.023497    0.024549    0.974507    15:53
  39        0.022984    0.024344    0.980811    16:46
  40        0.022573    0.024550    0.975100    16:50
  41        0.021948    0.024755    0.975661    17:01
  42        0.021552    0.024901    0.978628    16:35
  43        0.021424    0.026303    0.976205    17:54
  44        0.021114    0.027907    0.974397    19:30
  45        0.020531    0.026767    0.975772    14:39
  46        0.020167    0.026269    0.977444    19:40
  47        0.019798    0.025926    0.978046    15:15
  48        0.019570    0.025983    0.977883    12:59
  49        0.019310    0.026081    0.977558    15:37
  2024-04-11 03:47:00.382882       Export Model to *.pkl using pickle protocol - https://docs.fast.ai/learner.html#learner
  2024-04-11 03:47:01.498787       Done -  battus100_segm_c4_resnet18_b8_e50_s1200x800.pkl

  real    986m58.144s
  user    55m39.712s
  sys     2827m7.685s
  ```
